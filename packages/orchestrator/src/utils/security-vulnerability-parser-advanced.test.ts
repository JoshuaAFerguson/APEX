/**
 * Advanced Tests for SecurityVulnerabilityParser
 *
 * This file provides comprehensive tests for advanced CVSS parsing scenarios,
 * npm audit integration, and real-world vulnerability data processing.
 */

import { SecurityVulnerabilityParser, ParsedCVE, CVSSScore, NpmAuditResult } from './security-vulnerability-parser';
import type { SecurityVulnerability, VulnerabilitySeverity } from '../idle-processor';

describe('SecurityVulnerabilityParser - Advanced Scenarios', () => {
  describe('Complex CVSS Score Parsing', () => {
    it('should handle nested CVSS score objects from npm audit', () => {
      const complexCvssObjects = [
        // npm audit v2 format
        {
          cvss: {
            score: 9.8,
            vectorString: 'CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H'
          }
        },
        // npm audit v3 format
        {
          cvssV3: {
            baseScore: 7.5,
            temporalScore: 6.8,
            environmentalScore: 7.2,
            vectorString: 'CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H'
          }
        },
        // GitHub Security Advisory format
        {
          severity: 'HIGH',
          cvss: {
            score: 8.1,
            version: '3.1'
          }
        },
        // Alternative format
        {
          cvss_score: 6.5,
          cvss_version: '3.0'
        },
        // Multiple scores (should use highest)
        {
          cvss: { score: 7.5 },
          cvssV3: { baseScore: 8.2 },
          score: 6.1
        }
      ];

      const expectedScores = [9.8, 7.5, 8.1, 6.5, 8.2];

      complexCvssObjects.forEach((obj, index) => {
        const score = SecurityVulnerabilityParser.parseCVSSScore(obj);
        expect(score).toBe(expectedScores[index]);
      });
    });

    it('should handle CVSS scores from various text formats', () => {
      const textFormats = [
        'CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H/E:F/RL:O/RC:C (9.8)',
        'Base Score: 7.5 (High)',
        'Temporal Score: 6.8, Base Score: 8.1',
        'Score 5.4 | Vector: AV:N/AC:M/Au:N/C:P/I:P/A:N',
        'cvss: 9.0 (Critical)',
        'CVSS Base Score: 4.3',
        'Risk Score: 7.8/10',
        'Severity: High (CVSS: 8.9)',
        '{"cvss":{"score":6.7}}',
        'CVSS v3.1: 5.5 Medium'
      ];

      const expectedScores = [9.8, 7.5, 8.1, 5.4, 9.0, 4.3, 7.8, 8.9, 6.7, 5.5];

      textFormats.forEach((text, index) => {
        const score = SecurityVulnerabilityParser.parseCVSSScore(text);
        expect(score).toBe(expectedScores[index]);
      });
    });

    it('should handle malformed or conflicting CVSS data', () => {
      const malformedData = [
        { cvss: { score: 'invalid' } },
        { cvss: { baseScore: null } },
        { score: '9.8.1' }, // Invalid decimal format
        { cvss: {} }, // Empty object
        { cvss: { score: -1 } }, // Negative score
        { cvss: { score: 15 } }, // Score > 10
        'CVSS: invalid-score',
        'Score: N/A',
        { cvss: { score: NaN } },
        { cvss: { score: Infinity } }
      ];

      malformedData.forEach(data => {
        const result = SecurityVulnerabilityParser.parseCVSSScore(data);
        expect(result).toBeNull();
      });
    });
  });

  describe('Real-World npm Audit Output Processing', () => {
    it('should parse complex npm audit v8+ output', () => {
      const npmAuditV8Output = {
        auditReportVersion: 2,
        vulnerabilities: {
          'lodash': {
            name: 'lodash',
            severity: 'high',
            isDirect: false,
            via: [
              {
                source: 1067687,
                name: 'lodash',
                dependency: 'lodash',
                title: 'Command Injection in lodash',
                url: 'https://github.com/advisories/GHSA-jf85-cpcp-j695',
                severity: 'high',
                cwe: ['CWE-77'],
                cvss: {
                  score: 7.2,
                  vectorString: 'CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:U/C:H/I:H/A:H'
                },
                range: '<4.17.21'
              }
            ],
            effects: ['other-package'],
            range: '<4.17.21',
            nodes: ['node_modules/lodash'],
            fixAvailable: {
              name: 'lodash',
              version: '4.17.21',
              isSemVerMajor: false
            }
          }
        },
        metadata: {
          vulnerabilities: {
            high: 1,
            info: 0,
            low: 0,
            moderate: 0,
            total: 1,
            critical: 0
          }
        }
      };

      const result = SecurityVulnerabilityParser.parseNpmAuditOutput(npmAuditV8Output);

      expect(result).toHaveLength(1);
      expect(result[0]).toEqual({
        name: 'lodash',
        cveId: expect.stringContaining('GHSA-jf85-cpcp-j695'),
        severity: 'high',
        affectedVersions: '<4.17.21',
        description: expect.stringContaining('Command Injection')
      });
    });

    it('should handle npm audit output with multiple advisories per package', () => {
      const multiAdvisoryOutput = {
        vulnerabilities: {
          'axios': {
            name: 'axios',
            severity: 'moderate',
            via: [
              {
                source: 1234,
                title: 'Axios SSRF Protection Bypass',
                url: 'https://github.com/advisories/GHSA-cph5-m8f7-6c5x',
                severity: 'moderate',
                cvss: { score: 6.1 },
                range: '>=0.8.1 <0.28.0'
              },
              {
                source: 5678,
                title: 'Cross-Site Request Forgery in Axios',
                url: 'https://nvd.nist.gov/vuln/detail/CVE-2023-45857',
                severity: 'moderate',
                cvss: { score: 5.4 },
                range: '>=0.8.1 <1.6.0'
              }
            ],
            range: '>=0.8.1 <1.6.0'
          }
        }
      };

      const result = SecurityVulnerabilityParser.parseNpmAuditOutput(multiAdvisoryOutput);

      expect(result).toHaveLength(1);
      expect(result[0].name).toBe('axios');
      expect(result[0].severity).toBe('medium'); // Should use highest CVSS score (6.1)
      expect(result[0].cveId).toBe('CVE-2023-45857'); // Should prefer CVE over GHSA
    });

    it('should handle npm audit output with indirect dependencies', () => {
      const indirectDependencyOutput = {
        vulnerabilities: {
          'minimist': {
            name: 'minimist',
            severity: 'low',
            via: [
              {
                source: 1179,
                name: 'minimist',
                dependency: 'minimist',
                title: 'Prototype Pollution in minimist',
                url: 'https://github.com/advisories/GHSA-xvch-5gv4-984h',
                severity: 'low',
                cvss: { score: 3.3 },
                range: '<1.2.6'
              }
            ],
            effects: ['optimist', 'subarg', 'watchify'],
            range: '<1.2.6',
            nodes: [
              'node_modules/minimist',
              'node_modules/optimist/node_modules/minimist',
              'node_modules/subarg/node_modules/minimist'
            ],
            fixAvailable: {
              name: 'watchify',
              version: '4.0.0',
              isSemVerMajor: true
            }
          }
        }
      };

      const result = SecurityVulnerabilityParser.parseNpmAuditOutput(indirectDependencyOutput);

      expect(result).toHaveLength(1);
      expect(result[0].name).toBe('minimist');
      expect(result[0].severity).toBe('low');
      expect(result[0].description).toContain('Prototype Pollution');
    });

    it('should handle npm audit output with missing or incomplete data', () => {
      const incompleteOutput = {
        vulnerabilities: {
          'incomplete-package': {
            name: 'incomplete-package',
            severity: 'moderate',
            via: [
              {
                source: 9999,
                name: 'incomplete-package',
                // Missing title, url, cvss, range
                severity: 'moderate'
              }
            ]
          },
          'empty-via': {
            name: 'empty-via',
            severity: 'high',
            via: []
          },
          'null-severity': {
            name: 'null-severity',
            severity: null,
            via: [
              {
                source: 1111,
                name: 'null-severity',
                title: 'Unknown vulnerability',
                severity: null
              }
            ]
          }
        }
      };

      const result = SecurityVulnerabilityParser.parseNpmAuditOutput(incompleteOutput);

      // Should handle gracefully and create entries where possible
      expect(Array.isArray(result)).toBe(true);

      // Find the successfully parsed entry
      const parsed = result.find(v => v.name === 'incomplete-package');
      if (parsed) {
        expect(parsed.severity).toBe('medium'); // 'moderate' mapped to 'medium'
        expect(parsed.cveId).toContain('NO-CVE-'); // Fallback CVE ID
        expect(parsed.affectedVersions).toBe('unknown');
        expect(parsed.description).toBeTruthy();
      }
    });
  });

  describe('CVE Extraction from Various Sources', () => {
    it('should extract CVEs from GitHub Security Advisory URLs', () => {
      const ghsaUrls = [
        'https://github.com/advisories/GHSA-cfm4-qjh2-4765',
        'https://github.com/advisories/GHSA-jf85-cpcp-j695',
        'https://github.com/nodejs/security-wg/blob/main/vuln/core/CVE-2021-44228.json',
        'References: https://nvd.nist.gov/vuln/detail/CVE-2023-45857'
      ];

      const expectedCves = [
        [], // GHSA IDs are not CVEs
        [],
        ['CVE-2021-44228'],
        ['CVE-2023-45857']
      ];

      ghsaUrls.forEach((url, index) => {
        const result = SecurityVulnerabilityParser.extractCVEs(url);
        expect(result).toEqual(expectedCves[index]);
      });
    });

    it('should extract CVEs from vulnerability reports and changelogs', () => {
      const vulnerabilityTexts = [
        `# Security Update v1.2.3

         This release fixes CVE-2024-12345 affecting versions < 1.2.0.
         Also addresses CVE-2024-12346 in the authentication module.`,

        `## CHANGELOG

         ### [1.0.1] - 2024-01-15
         - Fix: Resolved cve-2024-99999 in parser module
         - Security: Patched vulnerability (no CVE assigned yet)`,

        `Vulnerability Report:
         - Package: lodash@4.17.15
         - CVE: CVE-2021-23337
         - CVSS: 7.2 (High)
         - Description: Command injection in template function`,

        'Mixed content with CVE-2021-44228, CVE-2022-12345, and some text without vulnerabilities'
      ];

      const expectedResults = [
        ['CVE-2024-12345', 'CVE-2024-12346'],
        ['CVE-2024-99999'],
        ['CVE-2021-23337'],
        ['CVE-2021-44228', 'CVE-2022-12345']
      ];

      vulnerabilityTexts.forEach((text, index) => {
        const result = SecurityVulnerabilityParser.extractCVEs(text);
        expect(result).toEqual(expectedResults[index]);
      });
    });
  });

  describe('Vulnerability Validation and Sanitization', () => {
    it('should validate vulnerability objects thoroughly', () => {
      const testVulnerabilities = [
        // Valid vulnerability
        {
          name: 'valid-package',
          cveId: 'CVE-2024-12345',
          severity: 'high',
          affectedVersions: '<1.0.0',
          description: 'Valid vulnerability description'
        },
        // Invalid - missing required fields
        {
          name: 'missing-fields',
          cveId: 'CVE-2024-12346'
          // Missing severity, affectedVersions, description
        },
        // Invalid - empty name
        {
          name: '',
          cveId: 'CVE-2024-12347',
          severity: 'medium',
          affectedVersions: '*',
          description: 'Empty name'
        },
        // Invalid - bad severity
        {
          name: 'bad-severity',
          cveId: 'CVE-2024-12348',
          severity: 'super-critical',
          affectedVersions: '*',
          description: 'Invalid severity level'
        },
        // Valid - minimal valid object
        {
          name: 'minimal-valid',
          cveId: 'CVE-2024-12349',
          severity: 'low',
          affectedVersions: 'unknown',
          description: 'Minimal but valid'
        }
      ];

      const validationResults = [true, false, false, false, true];

      testVulnerabilities.forEach((vuln, index) => {
        const isValid = SecurityVulnerabilityParser.isValidVulnerability(vuln);
        expect(isValid).toBe(validationResults[index]);
      });
    });

    it('should handle vulnerability creation with various input formats', () => {
      const inputFormats = [
        // Minimal input
        { name: 'minimal-package' },

        // Partial input with custom CVE
        {
          name: 'partial-package',
          cveId: 'CUSTOM-2024-001',
          severity: 'high'
        },

        // Complete input
        {
          name: 'complete-package',
          cveId: 'CVE-2024-12345',
          severity: 'critical',
          affectedVersions: '< 2.0.0',
          description: 'Complete vulnerability data'
        },

        // Input with extra properties (should be preserved)
        {
          name: 'extra-props',
          cveId: 'CVE-2024-12346',
          severity: 'medium',
          affectedVersions: '*',
          description: 'Has extra properties',
          extraProp: 'should be preserved'
        }
      ];

      const expectedDefaults = [
        {
          name: 'minimal-package',
          cveId: 'NO-CVE-MINIMAL-PACKAGE',
          severity: 'low',
          affectedVersions: 'unknown',
          description: 'Security vulnerability in minimal-package'
        },
        {
          name: 'partial-package',
          cveId: 'CUSTOM-2024-001',
          severity: 'high',
          affectedVersions: 'unknown',
          description: 'Security vulnerability in partial-package'
        },
        {
          name: 'complete-package',
          cveId: 'CVE-2024-12345',
          severity: 'critical',
          affectedVersions: '< 2.0.0',
          description: 'Complete vulnerability data'
        },
        {
          name: 'extra-props',
          cveId: 'CVE-2024-12346',
          severity: 'medium',
          affectedVersions: '*',
          description: 'Has extra properties',
          extraProp: 'should be preserved'
        }
      ];

      inputFormats.forEach((input, index) => {
        const result = SecurityVulnerabilityParser.createVulnerability(input as any);
        expect(result).toEqual(expectedDefaults[index]);
      });
    });
  });

  describe('Performance and Stress Testing', () => {
    it('should handle large npm audit outputs efficiently', () => {
      // Create a large npm audit output with many vulnerabilities
      const largeAuditOutput: any = {
        vulnerabilities: {}
      };

      // Generate 1000 vulnerability entries
      for (let i = 0; i < 1000; i++) {
        const packageName = `package-${i}`;
        largeAuditOutput.vulnerabilities[packageName] = {
          name: packageName,
          severity: ['low', 'moderate', 'high', 'critical'][i % 4],
          via: [
            {
              source: i,
              name: packageName,
              title: `Vulnerability in ${packageName}`,
              url: `https://example.com/CVE-2024-${String(i).padStart(5, '0')}`,
              severity: ['low', 'moderate', 'high', 'critical'][i % 4],
              cvss: { score: (i % 10) + 0.1 },
              range: '<1.0.0'
            }
          ]
        };
      }

      const startTime = Date.now();
      const result = SecurityVulnerabilityParser.parseNpmAuditOutput(largeAuditOutput);
      const endTime = Date.now();

      // Should complete within reasonable time
      expect(endTime - startTime).toBeLessThan(5000); // Less than 5 seconds
      expect(result).toHaveLength(1000);
      expect(result.every(v => SecurityVulnerabilityParser.isValidVulnerability(v))).toBe(true);
    });

    it('should handle deeply nested npm audit structures', () => {
      const deeplyNestedOutput = {
        vulnerabilities: {
          'deep-package': {
            name: 'deep-package',
            severity: 'high',
            via: [
              {
                source: 1,
                name: 'deep-package',
                title: 'Deep vulnerability',
                url: 'https://example.com/CVE-2024-99999',
                severity: 'high',
                cvss: {
                  score: 8.5,
                  version: '3.1',
                  vectorString: 'CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H',
                  baseMetrics: {
                    attackVector: 'NETWORK',
                    attackComplexity: 'LOW',
                    privilegesRequired: 'NONE',
                    userInteraction: 'NONE',
                    scope: 'UNCHANGED',
                    confidentialityImpact: 'HIGH',
                    integrityImpact: 'HIGH',
                    availabilityImpact: 'HIGH'
                  },
                  temporalMetrics: {
                    exploitCodeMaturity: 'FUNCTIONAL',
                    remediationLevel: 'OFFICIAL_FIX',
                    reportConfidence: 'CONFIRMED'
                  }
                },
                range: '<2.0.0'
              }
            ],
            effects: ['other-package'],
            range: '<2.0.0',
            nodes: ['node_modules/deep-package']
          }
        }
      };

      expect(() => {
        const result = SecurityVulnerabilityParser.parseNpmAuditOutput(deeplyNestedOutput);
        expect(result).toHaveLength(1);
        expect(result[0].name).toBe('deep-package');
        expect(result[0].cveId).toBe('CVE-2024-99999');
      }).not.toThrow();
    });
  });
});