/**
 * Unit Tests for SecurityVulnerabilityParser
 *
 * Tests CVE pattern matching, CVSS score parsing, severity categorization,
 * and npm audit output parsing functionality.
 */

import { SecurityVulnerabilityParser, ParsedCVE, CVSSScore, NpmAuditResult } from './security-vulnerability-parser';
import type { SecurityVulnerability, VulnerabilitySeverity } from '../idle-processor';

describe('SecurityVulnerabilityParser', () => {
  describe('extractCVEs', () => {
    it('should extract single CVE from text', () => {
      const result = SecurityVulnerabilityParser.extractCVEs('Found CVE-2021-44228 in log4j');
      expect(result).toEqual(['CVE-2021-44228']);
    });

    it('should extract multiple CVEs from text', () => {
      const result = SecurityVulnerabilityParser.extractCVEs('CVE-2021-44228 and CVE-2023-12345 were found');
      expect(result).toEqual(['CVE-2021-44228', 'CVE-2023-12345']);
    });

    it('should handle extended CVE format (5+ digits)', () => {
      const result = SecurityVulnerabilityParser.extractCVEs('Security issue CVE-2024-000001 detected');
      expect(result).toEqual(['CVE-2024-000001']);
    });

    it('should return empty array for no CVEs', () => {
      const result = SecurityVulnerabilityParser.extractCVEs('No vulnerabilities found');
      expect(result).toEqual([]);
    });

    it('should be case insensitive', () => {
      const result = SecurityVulnerabilityParser.extractCVEs('Found cve-2021-44228');
      expect(result).toEqual(['CVE-2021-44228']); // Normalized to uppercase
    });

    it('should handle mixed case CVEs', () => {
      const result = SecurityVulnerabilityParser.extractCVEs('cve-2021-44228 and CVE-2023-12345');
      expect(result).toEqual(['CVE-2021-44228', 'CVE-2023-12345']);
    });

    it('should handle empty or null input', () => {
      expect(SecurityVulnerabilityParser.extractCVEs('')).toEqual([]);
      expect(SecurityVulnerabilityParser.extractCVEs(null as any)).toEqual([]);
      expect(SecurityVulnerabilityParser.extractCVEs(undefined as any)).toEqual([]);
    });

    it('should handle non-string input gracefully', () => {
      expect(SecurityVulnerabilityParser.extractCVEs(123 as any)).toEqual([]);
      expect(SecurityVulnerabilityParser.extractCVEs({} as any)).toEqual([]);
    });

    it('should extract CVEs from URLs', () => {
      const url = 'https://nvd.nist.gov/vuln/detail/CVE-2021-44228';
      const result = SecurityVulnerabilityParser.extractCVEs(url);
      expect(result).toEqual(['CVE-2021-44228']);
    });

    it('should handle malformed CVE patterns', () => {
      // Too short year
      expect(SecurityVulnerabilityParser.extractCVEs('CVE-21-1234')).toEqual([]);
      // Too short sequence
      expect(SecurityVulnerabilityParser.extractCVEs('CVE-2021-123')).toEqual([]);
      // Invalid characters
      expect(SecurityVulnerabilityParser.extractCVEs('CVE-2021-ABCD')).toEqual([]);
    });
  });

  describe('isValidCVE', () => {
    it('should validate correct CVE format', () => {
      expect(SecurityVulnerabilityParser.isValidCVE('CVE-2021-44228')).toBe(true);
      expect(SecurityVulnerabilityParser.isValidCVE('CVE-2024-000001')).toBe(true);
      expect(SecurityVulnerabilityParser.isValidCVE('CVE-2023-12345')).toBe(true);
    });

    it('should reject invalid CVE format', () => {
      expect(SecurityVulnerabilityParser.isValidCVE('CVE-21-1234')).toBe(false); // Invalid year
      expect(SecurityVulnerabilityParser.isValidCVE('CVE-2021-123')).toBe(false); // Sequence too short
      expect(SecurityVulnerabilityParser.isValidCVE('CVE-2021-ABCD')).toBe(false); // Non-numeric sequence
      expect(SecurityVulnerabilityParser.isValidCVE('INVALID-2021-1234')).toBe(false); // Wrong prefix
      expect(SecurityVulnerabilityParser.isValidCVE('')).toBe(false);
      expect(SecurityVulnerabilityParser.isValidCVE(null as any)).toBe(false);
      expect(SecurityVulnerabilityParser.isValidCVE(undefined as any)).toBe(false);
    });

    it('should be case sensitive for validation', () => {
      expect(SecurityVulnerabilityParser.isValidCVE('cve-2021-44228')).toBe(false);
      expect(SecurityVulnerabilityParser.isValidCVE('Cve-2021-44228')).toBe(false);
    });
  });

  describe('parseCVE', () => {
    it('should parse valid CVE into components', () => {
      const result = SecurityVulnerabilityParser.parseCVE('CVE-2021-44228');
      expect(result).toEqual({
        id: 'CVE-2021-44228',
        year: 2021,
        sequence: 44228,
      });
    });

    it('should handle extended sequence numbers', () => {
      const result = SecurityVulnerabilityParser.parseCVE('CVE-2024-000001');
      expect(result).toEqual({
        id: 'CVE-2024-000001',
        year: 2024,
        sequence: 1,
      });
    });

    it('should normalize case', () => {
      const result = SecurityVulnerabilityParser.parseCVE('cve-2021-44228');
      expect(result).toEqual({
        id: 'CVE-2021-44228',
        year: 2021,
        sequence: 44228,
      });
    });

    it('should return null for invalid CVE', () => {
      expect(SecurityVulnerabilityParser.parseCVE('CVE-21-1234')).toBe(null);
      expect(SecurityVulnerabilityParser.parseCVE('invalid')).toBe(null);
      expect(SecurityVulnerabilityParser.parseCVE('')).toBe(null);
    });
  });

  describe('parseCVSSScore', () => {
    it('should parse numeric CVSS scores', () => {
      expect(SecurityVulnerabilityParser.parseCVSSScore(9.8)).toBe(9.8);
      expect(SecurityVulnerabilityParser.parseCVSSScore(0.0)).toBe(0.0);
      expect(SecurityVulnerabilityParser.parseCVSSScore(10.0)).toBe(10.0);
    });

    it('should parse CVSS from strings', () => {
      expect(SecurityVulnerabilityParser.parseCVSSScore('CVSS: 9.8')).toBe(9.8);
      expect(SecurityVulnerabilityParser.parseCVSSScore('cvss: 7.5')).toBe(7.5);
      expect(SecurityVulnerabilityParser.parseCVSSScore('score: 5.2')).toBe(5.2);
      expect(SecurityVulnerabilityParser.parseCVSSScore('9.8')).toBe(9.8);
    });

    it('should parse CVSS from objects', () => {
      expect(SecurityVulnerabilityParser.parseCVSSScore({ score: 9.8 })).toBe(9.8);
      expect(SecurityVulnerabilityParser.parseCVSSScore({ cvss: { score: 7.5 } })).toBe(7.5);
    });

    it('should handle invalid inputs', () => {
      expect(SecurityVulnerabilityParser.parseCVSSScore('invalid')).toBe(null);
      expect(SecurityVulnerabilityParser.parseCVSSScore('')).toBe(null);
      expect(SecurityVulnerabilityParser.parseCVSSScore(null as any)).toBe(null);
      expect(SecurityVulnerabilityParser.parseCVSSScore(undefined as any)).toBe(null);
      expect(SecurityVulnerabilityParser.parseCVSSScore({})).toBe(null);
    });

    it('should cap scores above 10.0', () => {
      expect(SecurityVulnerabilityParser.parseCVSSScore(15.0)).toBe(10.0);
      expect(SecurityVulnerabilityParser.parseCVSSScore('CVSS: 12.5')).toBe(10.0);
    });

    it('should handle negative scores', () => {
      expect(SecurityVulnerabilityParser.parseCVSSScore(-1.0)).toBe(null);
      expect(SecurityVulnerabilityParser.parseCVSSScore('CVSS: -5.0')).toBe(null);
    });

    it('should handle NaN values', () => {
      expect(SecurityVulnerabilityParser.parseCVSSScore(NaN)).toBe(null);
    });
  });

  describe('severityFromCVSS', () => {
    it('should return critical for 9.0-10.0', () => {
      expect(SecurityVulnerabilityParser.severityFromCVSS(9.0)).toBe('critical');
      expect(SecurityVulnerabilityParser.severityFromCVSS(9.5)).toBe('critical');
      expect(SecurityVulnerabilityParser.severityFromCVSS(10.0)).toBe('critical');
    });

    it('should return high for 7.0-8.9', () => {
      expect(SecurityVulnerabilityParser.severityFromCVSS(7.0)).toBe('high');
      expect(SecurityVulnerabilityParser.severityFromCVSS(8.0)).toBe('high');
      expect(SecurityVulnerabilityParser.severityFromCVSS(8.9)).toBe('high');
    });

    it('should return medium for 4.0-6.9', () => {
      expect(SecurityVulnerabilityParser.severityFromCVSS(4.0)).toBe('medium');
      expect(SecurityVulnerabilityParser.severityFromCVSS(5.5)).toBe('medium');
      expect(SecurityVulnerabilityParser.severityFromCVSS(6.9)).toBe('medium');
    });

    it('should return low for 0.1-3.9', () => {
      expect(SecurityVulnerabilityParser.severityFromCVSS(0.1)).toBe('low');
      expect(SecurityVulnerabilityParser.severityFromCVSS(2.0)).toBe('low');
      expect(SecurityVulnerabilityParser.severityFromCVSS(3.9)).toBe('low');
    });

    it('should handle edge cases', () => {
      expect(SecurityVulnerabilityParser.severityFromCVSS(0)).toBe('low');
      expect(SecurityVulnerabilityParser.severityFromCVSS(-1)).toBe('low'); // Defensive
      expect(SecurityVulnerabilityParser.severityFromCVSS(11)).toBe('critical'); // Above max
    });

    it('should handle boundary values correctly', () => {
      expect(SecurityVulnerabilityParser.severityFromCVSS(3.9)).toBe('low');
      expect(SecurityVulnerabilityParser.severityFromCVSS(4.0)).toBe('medium');
      expect(SecurityVulnerabilityParser.severityFromCVSS(6.9)).toBe('medium');
      expect(SecurityVulnerabilityParser.severityFromCVSS(7.0)).toBe('high');
      expect(SecurityVulnerabilityParser.severityFromCVSS(8.9)).toBe('high');
      expect(SecurityVulnerabilityParser.severityFromCVSS(9.0)).toBe('critical');
    });
  });

  describe('parseSeverityLabel', () => {
    it('should parse standard severity labels', () => {
      expect(SecurityVulnerabilityParser.parseSeverityLabel('critical')).toBe('critical');
      expect(SecurityVulnerabilityParser.parseSeverityLabel('high')).toBe('high');
      expect(SecurityVulnerabilityParser.parseSeverityLabel('medium')).toBe('medium');
      expect(SecurityVulnerabilityParser.parseSeverityLabel('low')).toBe('low');
    });

    it('should handle alternative severity labels', () => {
      expect(SecurityVulnerabilityParser.parseSeverityLabel('moderate')).toBe('medium');
      expect(SecurityVulnerabilityParser.parseSeverityLabel('info')).toBe('low');
      expect(SecurityVulnerabilityParser.parseSeverityLabel('informational')).toBe('low');
    });

    it('should be case insensitive', () => {
      expect(SecurityVulnerabilityParser.parseSeverityLabel('CRITICAL')).toBe('critical');
      expect(SecurityVulnerabilityParser.parseSeverityLabel('High')).toBe('high');
      expect(SecurityVulnerabilityParser.parseSeverityLabel('MODERATE')).toBe('medium');
    });

    it('should handle unknown labels', () => {
      expect(SecurityVulnerabilityParser.parseSeverityLabel('unknown')).toBe('low');
      expect(SecurityVulnerabilityParser.parseSeverityLabel('invalid')).toBe('low');
      expect(SecurityVulnerabilityParser.parseSeverityLabel('')).toBe('low');
      expect(SecurityVulnerabilityParser.parseSeverityLabel(null as any)).toBe('low');
      expect(SecurityVulnerabilityParser.parseSeverityLabel(undefined as any)).toBe('low');
    });

    it('should trim whitespace', () => {
      expect(SecurityVulnerabilityParser.parseSeverityLabel('  critical  ')).toBe('critical');
      expect(SecurityVulnerabilityParser.parseSeverityLabel('\thigh\n')).toBe('high');
    });
  });

  describe('createVulnerability', () => {
    it('should create vulnerability with complete data', () => {
      const data = {
        name: 'lodash',
        cveId: 'CVE-2021-23337',
        severity: 'high' as VulnerabilitySeverity,
        affectedVersions: '<4.17.21',
        description: 'Command injection vulnerability',
      };

      const result = SecurityVulnerabilityParser.createVulnerability(data);
      expect(result).toEqual(data);
    });

    it('should create vulnerability with minimal data', () => {
      const result = SecurityVulnerabilityParser.createVulnerability({ name: 'lodash' });
      expect(result).toEqual({
        name: 'lodash',
        cveId: 'NO-CVE-LODASH',
        severity: 'low',
        affectedVersions: 'unknown',
        description: 'Security vulnerability in lodash',
      });
    });

    it('should create vulnerability with partial data', () => {
      const data = {
        name: 'axios',
        cveId: 'CVE-2021-3749',
        severity: 'medium' as VulnerabilitySeverity,
      };

      const result = SecurityVulnerabilityParser.createVulnerability(data);
      expect(result).toEqual({
        name: 'axios',
        cveId: 'CVE-2021-3749',
        severity: 'medium',
        affectedVersions: 'unknown',
        description: 'Security vulnerability in axios',
      });
    });
  });

  describe('isValidVulnerability', () => {
    it('should validate complete vulnerability object', () => {
      const vulnerability: SecurityVulnerability = {
        name: 'lodash',
        cveId: 'CVE-2021-23337',
        severity: 'high',
        affectedVersions: '<4.17.21',
        description: 'Command injection vulnerability',
      };

      expect(SecurityVulnerabilityParser.isValidVulnerability(vulnerability)).toBe(true);
    });

    it('should reject invalid vulnerability objects', () => {
      expect(SecurityVulnerabilityParser.isValidVulnerability(null)).toBe(false);
      expect(SecurityVulnerabilityParser.isValidVulnerability(undefined)).toBe(false);
      expect(SecurityVulnerabilityParser.isValidVulnerability({})).toBe(false);
      expect(SecurityVulnerabilityParser.isValidVulnerability({ name: '' })).toBe(false);
      expect(SecurityVulnerabilityParser.isValidVulnerability({ name: 'lodash' })).toBe(false); // Missing fields
    });

    it('should reject invalid severity values', () => {
      const invalid = {
        name: 'lodash',
        cveId: 'CVE-2021-23337',
        severity: 'invalid',
        affectedVersions: '<4.17.21',
        description: 'Command injection vulnerability',
      };

      expect(SecurityVulnerabilityParser.isValidVulnerability(invalid)).toBe(false);
    });
  });

  describe('parseNpmAuditOutput', () => {
    it('should parse npm audit v2 format', () => {
      const npmAuditOutput: NpmAuditResult = {
        auditReportVersion: 2,
        vulnerabilities: {
          'lodash': {
            name: 'lodash',
            severity: 'high',
            isDirect: false,
            via: [{
              source: 1234,
              name: 'lodash',
              dependency: 'lodash',
              title: 'Command Injection in lodash',
              url: 'https://github.com/advisories/GHSA-35jh-r3h4-6jhm',
              severity: 'high',
              cwe: ['CWE-94'],
              cvss: { score: 8.1, vectorString: 'CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:N' },
              range: '<4.17.21'
            }],
            effects: [],
            range: '<4.17.21',
            nodes: ['node_modules/lodash'],
            fixAvailable: true
          }
        },
        metadata: {
          vulnerabilities: {
            info: 0,
            low: 0,
            moderate: 0,
            high: 1,
            critical: 0,
            total: 1
          }
        }
      };

      const result = SecurityVulnerabilityParser.parseNpmAuditOutput(npmAuditOutput);
      expect(result).toHaveLength(1);
      expect(result[0]).toEqual({
        name: 'lodash',
        cveId: expect.any(String), // Will be generated from URL or fallback
        severity: 'high',
        affectedVersions: '<4.17.21',
        description: 'Command Injection in lodash',
      });
    });

    it('should handle missing CVSS data gracefully', () => {
      const npmAuditOutput: NpmAuditResult = {
        vulnerabilities: {
          'minimist': {
            name: 'minimist',
            severity: 'moderate',
            isDirect: false,
            via: [{
              name: 'minimist',
              title: 'Prototype pollution vulnerability',
              severity: 'moderate',
              range: '<1.2.6'
            }],
            effects: [],
            range: '<1.2.6',
            nodes: ['node_modules/minimist'],
            fixAvailable: true
          }
        }
      };

      const result = SecurityVulnerabilityParser.parseNpmAuditOutput(npmAuditOutput);
      expect(result).toHaveLength(1);
      expect(result[0].severity).toBe('medium'); // 'moderate' mapped to 'medium'
      expect(result[0].name).toBe('minimist');
    });

    it('should extract CVE from via.url field', () => {
      const npmAuditOutput: NpmAuditResult = {
        vulnerabilities: {
          'axios': {
            name: 'axios',
            severity: 'high',
            isDirect: true,
            via: [{
              url: 'https://nvd.nist.gov/vuln/detail/CVE-2021-3749',
              title: 'Regular expression denial of service',
              severity: 'high',
              range: '<0.21.2'
            }],
            effects: [],
            range: '<0.21.2',
            nodes: ['node_modules/axios'],
            fixAvailable: true
          }
        }
      };

      const result = SecurityVulnerabilityParser.parseNpmAuditOutput(npmAuditOutput);
      expect(result).toHaveLength(1);
      expect(result[0].cveId).toBe('CVE-2021-3749');
    });

    it('should handle empty or malformed audit output', () => {
      expect(SecurityVulnerabilityParser.parseNpmAuditOutput({})).toEqual([]);
      expect(SecurityVulnerabilityParser.parseNpmAuditOutput(null)).toEqual([]);
      expect(SecurityVulnerabilityParser.parseNpmAuditOutput(undefined)).toEqual([]);
      expect(SecurityVulnerabilityParser.parseNpmAuditOutput({ vulnerabilities: null })).toEqual([]);
      expect(SecurityVulnerabilityParser.parseNpmAuditOutput({ vulnerabilities: {} })).toEqual([]);
    });

    it('should handle malformed vulnerability entries', () => {
      const npmAuditOutput = {
        vulnerabilities: {
          'malformed': {
            // Missing required fields
            severity: 'high',
          },
          'valid': {
            name: 'lodash',
            severity: 'low',
            isDirect: false,
            via: [],
            effects: [],
            range: '*',
            nodes: [],
            fixAvailable: false
          }
        }
      };

      const result = SecurityVulnerabilityParser.parseNpmAuditOutput(npmAuditOutput);
      expect(result).toHaveLength(1); // Only valid entry processed
      expect(result[0].name).toBe('lodash');
    });

    it('should prioritize CVSS score over severity label', () => {
      const npmAuditOutput: NpmAuditResult = {
        vulnerabilities: {
          'test-package': {
            name: 'test-package',
            severity: 'low', // Label says low
            isDirect: false,
            via: [{
              cvss: { score: 9.5 }, // But CVSS indicates critical
              severity: 'low',
              title: 'Test vulnerability',
              range: '*'
            }],
            effects: [],
            range: '*',
            nodes: [],
            fixAvailable: false
          }
        }
      };

      const result = SecurityVulnerabilityParser.parseNpmAuditOutput(npmAuditOutput);
      expect(result).toHaveLength(1);
      expect(result[0].severity).toBe('critical'); // CVSS-based severity should win
    });
  });

  describe('Integration Tests', () => {
    it('should handle real-world npm audit output patterns', () => {
      // Test with actual npm audit output structure
      const realWorldExample = {
        auditReportVersion: 2,
        vulnerabilities: {
          'node-forge': {
            name: 'node-forge',
            severity: 'high',
            isDirect: false,
            via: [
              {
                source: 1074,
                name: 'node-forge',
                dependency: 'node-forge',
                title: 'Improper Verification of Cryptographic Signature in node-forge',
                url: 'https://github.com/advisories/GHSA-cfm4-qjh2-4765',
                severity: 'high',
                cwe: ['CWE-347'],
                cvss: {
                  score: 7.5,
                  vectorString: 'CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N'
                },
                range: '<1.0.0'
              }
            ],
            effects: ['@babel/traverse'],
            range: '<1.0.0',
            nodes: ['node_modules/node-forge'],
            fixAvailable: {
              name: '@babel/traverse',
              version: '7.23.2',
              isSemVerMajor: false
            }
          }
        }
      };

      const result = SecurityVulnerabilityParser.parseNpmAuditOutput(realWorldExample);

      expect(result).toHaveLength(1);
      expect(result[0]).toEqual({
        name: 'node-forge',
        cveId: expect.stringContaining('GHSA-cfm4-qjh2-4765'),
        severity: 'high', // CVSS 7.5 maps to high
        affectedVersions: '<1.0.0',
        description: 'Improper Verification of Cryptographic Signature in node-forge',
      });
    });

    it('should handle complex vulnerability scenarios', () => {
      const complexScenario = {
        vulnerabilities: {
          'multi-issue-package': {
            name: 'multi-issue-package',
            severity: 'critical',
            isDirect: true,
            via: [
              {
                title: 'Critical RCE vulnerability',
                url: 'https://example.com/CVE-2024-12345',
                cvss: { score: 10.0 },
                severity: 'critical'
              },
              {
                title: 'Another issue',
                severity: 'medium',
                // No CVSS score for this one
              }
            ],
            effects: [],
            range: '<2.0.0',
            nodes: ['node_modules/multi-issue-package'],
            fixAvailable: true
          }
        }
      };

      const result = SecurityVulnerabilityParser.parseNpmAuditOutput(complexScenario);

      expect(result).toHaveLength(1);
      expect(result[0].severity).toBe('critical'); // Should use highest CVSS score
      expect(result[0].cveId).toBe('CVE-2024-12345'); // Should extract from URL
    });
  });
});