# Publishing Guide

This guide describes how to publish new versions of APEX to NPM and Homebrew.

## Prerequisites

- Access to the `apexcli` organization on NPM (or your personal scope).
- Write access to this GitHub repository.
- `npm` authenticated locally.

## Release Process

### 1. Version Bump & Tag

We use Semantic Versioning. Determine the next version number (e.g., `0.3.1`).

1. Update the version in `package.json` files.

    ```bash
    # You can use a tool or do it manually
    npm version patch -ws --no-git-tag-version
    ```

2. Commit the version bump.

    ```bash
    git commit -am "chore: release v0.3.1"
    ```

3. Create and push a git tag.

    ```bash
    git tag v0.3.1
    git push origin v0.3.1
    ```

### 2. NPM Publishing (Automated)

The GitHub Action workflow `.github/workflows/release.yml` will automatically trigger when you push a tag starting with `v*`.
It will:

- Build the project.
- Run tests.
- Publish packages to NPM.
- Create a GitHub Release draft.

### 3. Homebrew Distribution (Manual Step Authorization)

Homebrew installs via a "Formula". Our formula is located at `Formula/apex.rb`.
When a new version is released, clients need a way to verify the file integrity. This requires updating the `sha256` checksum in the formula.

**Steps to update Homebrew:**

1. **Wait for the Release**: Ensure the GitHub Release for `v0.3.1` is created and the source code tarball is available (usually auto-generated by GitHub).
    - URL format: `https://github.com/JoshuaAFerguson/apex/archive/refs/tags/v0.3.1.tar.gz`

2. **Calculate SHA256**:
    Download the tarball and calculate its hash.

    ```bash
    curl -L -o apex.tar.gz https://github.com/JoshuaAFerguson/apex/archive/refs/tags/v0.3.1.tar.gz
    shasum -a 256 apex.tar.gz
    ```

3. **Update Formula**:
    Edit `Formula/apex.rb`:
    - Update `url`: Ensure it points to the new tag.
    - Update `sha256`: Paste the new hash you calculated.

    ```ruby
    # Formula/apex.rb
    url "https://github.com/JoshuaAFerguson/apex/archive/refs/tags/v0.3.1.tar.gz"
    sha256 "new_sha_hash_here..."
    ```

4. **Push Changes**:
    Commit and push the updated formula to `main`.

    ```bash
    git add Formula/apex.rb
    git commit -m "chore: update homebrew formula to v0.3.1"
    git push origin main
    ```

Users can now run `brew update && brew upgrade apex` to get the latest version.

## Troubleshooting

### "Formula not found"

Ensure the user has tapped the repository correctly:

```bash
brew tap joshuaaferguson/apex
```

This tells brew to look for formulas in `https://github.com/JoshuaAFerguson/homebrew-apex` OR (if that doesn't exist) it falls back to looking in the root of `https://github.com/JoshuaAFerguson/apex`.

### Checksum Mismatch

If users report checksum errors, it means the file they downloaded doesn't match the `sha256` in the formula. Double check that you calculated the hash from the *exact* same file URL that is in the formula. GitHub auto-generated tarballs are generally stable but can change if git tags are moved.
